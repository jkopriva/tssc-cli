---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: e2e-main-pipeline
  namespace: rhtap-shared-team-tenant
  labels:
    appstudio.openshift.io/component: tssc-cli
    appstudio.openshift.io/application: tssc-cli
spec:
  params:
    - name: SNAPSHOT
      description: "The JSON string representing the snapshot of the application under test."
      default: '{"components": [{"name":"test-app", "containerImage": "quay.io/example/repo:latest"}]}'
      type: string
    - name: konflux-test-infra-secret
      description: The name of secret where testing infrastructures credentials are stored.
      type: string
    - name: cloud-credential-key
      description: The key secret from konflux-test-infra-secret where all AWS ROSA configurations are stored.
      type: string
    - name: ocp-instance-type
      description: 'The type of machine to use for the cluster nodes.'
      default: "m5.2xlarge"
      type: string
    - name: ocp-replicas
      description: 'The number of replicas for the cluster nodes.'
      default: "3"
      type: string
  tasks:
    - name: test-metadata
      taskRef:
        resolver: git
        params:
          - name: url
            value: https://github.com/konflux-ci/konflux-qe-definitions.git
          - name: revision
            value: main
          - name: pathInRepo
            value: common/tasks/test-metadata/0.2/test-metadata.yaml
      params:
        - name: SNAPSHOT
          value: $(params.SNAPSHOT)
        - name: test-name
          value: $(context.pipelineRun.name)
    - name: process-rhads-config
      taskSpec:
        volumes:
          - name: shared-data
            emptyDir: {}
        results:
          - name: rhads-config
            description: JSON formatted configuration data
        steps:
          - name: get-rhads-config
            image: quay.io/konflux-ci/appstudio-utils:ab6b0b8e40e440158e7288c73aff1cf83a2cc8a9@sha256:24179f0efd06c65d16868c2d7eb82573cce8e43533de6cea14fec3b7446e0b14
            env:
              - name: JOB_SPEC
                value: $(tasks.test-metadata.results.job-spec)
            volumeMounts:
              - name: shared-data
                mountPath: /shared
            script: |
              #!/usr/bin/env bash

              echo "Downloading rhads-config file:"
              GIT_REPO="$(jq -r '.git.repo // empty' <<< $JOB_SPEC)"
              REPO_ORG=$(jq -r '.git.source_repo_org' <<< $JOB_SPEC)
              BRANCH=$(jq -r '.git.source_repo_branch' <<< $JOB_SPEC)

              rhads_config_file_location="integration-tests/config/rhads-config"
              curl -o rhads-config https://raw.githubusercontent.com/$REPO_ORG/$GIT_REPO/refs/heads/$BRANCH/$rhads_config_file_location

              cat rhads-config | tee $(results.rhads-config.path)
    - name: start-nested-pipelines
      runAfter:
        - test-metadata
        - process-rhads-config
      taskRef:
        resolver: git
        params:
          - name: url
            value: https://github.com/jkopriva/tssc-cli.git
          - name: revision
            value: RHTAP-5290
          - name: pathInRepo
            value: integration-tests/tasks/start-pipelines.yaml
      params:
        - name: snapshot
          value: $(params.SNAPSHOT)
        - name: job-spec
          value: $(tasks.test-metadata.results.job-spec)
        - name: rhads-config
          value: $(tasks.process-rhads-config.results.rhads-config)
        - name: mode
          value: "single"
        - name: konflux-test-infra-secret
          value: $(params.konflux-test-infra-secret)
        - name: cloud-credential-key
          value: $(params.cloud-credential-key)
        - name: ocp-instance-type
          value: $(params.ocp-instance-type)
        - name: ocp-replicas
          value: $(params.ocp-replicas)
        - name: context-pipeline-run-name
          value: $(context.pipelineRun.name)
